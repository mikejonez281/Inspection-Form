<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Property Inspection Report (Hard Fix for PDF Clipping)</title>
    <!-- Web App Manifest (for Android "Add to Home screen") -->
    <link rel="manifest" href="manifest.json">

    <!-- Theme Color for Chrome, Firefox OS and Opera -->
    <meta name="theme-color" content="#0b2d6a">

    <!-- iOS Web App Meta Tags -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="default">
    <meta name="apple-mobile-web-app-title" content="Inspection">
    <link rel="apple-touch-icon" href="https://i.imgur.com/TGxSq1Q.jpg">
    <!-- Load Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- PDF Generation Libraries -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    
    <style>
        /* Custom styles for a clean, professional look */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f0f4f8;
        }
        .container {
            max-width: 1100px;
        }
        
        /* Default styling for the editable inputs */
        .input-notes {
            min-height: 80px; 
            resize: vertical;
            white-space: normal;
            word-break: break-word;
            overflow: auto; 
            /* Ensure this class applies to the large text areas as well */
            line-height: 1.5; /* Crucial for spacing */
            padding: 0.5rem 0.75rem;
        }
        
        /* Styling for the temporary plain text elements in PDF mode */
        .pdf-temp-text {
            /* Mimic the appearance of the original text area but as a div/p */
            border: 1px solid #e5e7eb; /* gray-200 */
            background-color: #ffffff;
            padding: 0.75rem 1rem;
            min-height: 80px;
            white-space: pre-wrap; /* Preserve line breaks and spaces */
            word-break: break-word;
            line-height: 1.5;
            box-sizing: border-box;
            border-radius: 0.375rem; /* rounded-md */
        }
        
        /* Styling for temporary plain text inputs in PDF mode */
        .pdf-temp-input {
            display: flex;
            align-items: center;
            background-color: #ffffff;
            min-height: 2.5rem; /* Ensure sufficient height for text */
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Grid layout for 3 status columns: Item | OK | N/A | R | Notes */
        .check-item {
            display: grid;
            grid-template-columns: 4fr repeat(3, 1fr) 5fr; 
            gap: 1rem;
            align-items: center;
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #e2e8f0;
        }
        .check-item:last-child {
            border-bottom: none;
        }
        .section-header {
            background-color: #e0f2fe; /* Light Blue */
            color: #0b2d6a; /* Dark Blue Text */
            padding: 0.75rem 1rem;
            font-weight: 700;
            border-radius: 0.5rem;
            margin-top: 1.5rem; 
            border-left: 5px solid #0077c9;
        }
        .status-label {
            display: flex;
            justify-content: center;
            font-size: 0.75rem;
            font-weight: 600;
            text-transform: uppercase;
        }
        .signature-box {
            border: 1px solid #cbd5e1; /* slate-300 */
            border-radius: 0.5rem;
            height: 120px; 
            background-color: #fff;
            touch-action: none; 
        }
        
        #report-content {
            padding-bottom: 4rem !important;
        }
        
        /* ========================================================================= */
        /* --- PDF SPECIFIC STYLES (CRITICAL TEXT CLIPPING FIX) --- */
        @media print {
            .signature-box {
                border: 1px solid #000;
                background-color: #fff;
            }
            .action-buttons, .template-section {
                display: none !important;
            }
            .container {
                box-shadow: none !important;
            }

            /* Ensure all dynamic text content wraps correctly in PDF */
            .pdf-temp-text {
                line-height: 1.5 !important; 
                overflow: visible !important; 
                height: auto !important; 
                min-height: auto !important; 
                box-sizing: border-box !important;
                /* Remove border for cleaner PDF lines */
                border: none !important; 
                background-color: transparent !important;
                padding: 0 !important;
            }
            
            .pdf-temp-input {
                border: none !important;
                padding: 0 !important;
                align-items: flex-start !important;
            }

            /* Hide the original textarea in case something goes wrong */
            textarea {
                display: none !important; 
            }
            
            .no-page-break {
                page-break-inside: avoid;
                break-inside: avoid;
            }
        }
        /* ========================================================================= */
    </style>
</head>
<body class="p-4 sm:p-8 md:p-12">
    <!-- Main content container with ID for PDF capture -->
    <div id="report-content" class="container mx-auto bg-white shadow-2xl rounded-2xl p-6 sm:p-10">
        <!-- HEADER WITH LOGO AND TITLE -->
        <div class="flex justify-between items-center pb-4 border-b-4 border-blue-600 mb-8">
            <h1 class="text-4xl font-extrabold text-blue-800 tracking-tight">
                Property Inspection Report
            </h1>
            <img src="https://i.imgur.com/TGxSq1Q.jpg" 
                 alt="Valverde Rentals Logo" 
                 crossorigin="anonymous"
                 class="h-16 w-auto object-contain rounded-lg shadow-md"
                 onerror="this.onerror=null; this.src='https://placehold.co/180x60/cccccc/000000?text=Logo+Missing';">
        </div>

        <!-- TEMPLATE & TYPE SECTION -->
        <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Inspection Details & Type</h2>
        <div class="grid grid-cols-1 md:grid-cols-3 gap-6 mb-8 text-sm">
            <!-- Changed p-3 to px-3 py-2 -->
            <div>
                <label for="inspection-type" class="block font-semibold text-gray-700 mb-1">Inspection Type:</label>
                <select id="inspection-type" data-pdf-swap class="w-full px-3 py-2 border border-gray-300 rounded-lg bg-white focus:ring-blue-500 focus:border-blue-500">
                    <option value="MidTerm">Mid-Term Check</option>
                    <option value="MoveIn">Move-In Condition</option>
                    <option value="MoveOut">Move-Out Condition</option>
                </select>
                <p class="text-xs text-gray-500 mt-1 leading-normal">Saves report using this type.</p>
            </div>
            <!-- UPDATED: property-address input to pt-1 pb-1 for higher vertical alignment -->
            <div class="md:col-span-2">
                <label for="property-address" class="block font-semibold text-gray-700 mb-1">Property Address (Unique Identifier):</label>
                <input type="text" id="property-address" data-pdf-swap placeholder="123 Main St, Anytown, FL 33000" class="w-full px-3 pt-1 pb-1 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
                <p class="text-xs text-gray-500 mt-1">Changing address + type loads/saves a different report.</p>
            </div>
        </div>

        <!-- TEMPLATE MANAGEMENT -->
        <div class="template-section bg-indigo-50 p-4 rounded-xl border border-indigo-200 mb-6 text-sm flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4">
            <div class="flex flex-col sm:flex-row gap-4 w-full sm:w-1/2">
                 <div class="w-full">
                    <label for="template-name" class="block font-semibold text-indigo-800 mb-1">Template Name:</label>
                    <input type="text" id="template-name" placeholder="E.g., 3 Bedroom Standard" class="w-full p-2 border border-indigo-300 rounded-lg focus:ring-indigo-500 focus:border-indigo-500">
                </div>
            </div>
            <div class="flex gap-4 w-full sm:w-auto">
                <button onclick="saveAsTemplate()" class="flex-1 px-4 py-2 bg-indigo-600 text-white font-bold rounded-lg shadow-md hover:bg-indigo-700 transition duration-150">
                    Save Template
                </button>
                <button onclick="loadTemplate()" class="flex-1 px-4 py-2 bg-indigo-200 text-indigo-800 font-bold rounded-lg shadow-md hover:bg-indigo-300 transition duration-150">
                    Load Template
                </button>
            </div>
        </div>
        
        <!-- FURTHER DETAILS -->
        <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8 text-sm">
            <!-- UPDATED: tenant-name input to pt-1 pb-1 for higher vertical alignment -->
            <div>
                <label for="tenant-name" class="block font-semibold text-gray-700 mb-1">Tenant Name(s):</label>
                <input type="text" id="tenant-name" data-pdf-swap placeholder="John & Jane Doe" class="w-full px-3 pt-1 pb-1 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            </div>
            <!-- UPDATED: inspector-name input to pt-1 pb-1 for higher vertical alignment -->
            <div>
                <label for="inspector-name" class="block font-semibold text-gray-700 mb-1">Inspector/Agent Name:</label>
                <input type="text" id="inspector-name" data-pdf-swap placeholder="Agent Name" class="w-full px-3 pt-1 pb-1 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            </div>
            <!-- UPDATED: inspection-date input to pt-1 pb-1 for consistency -->
            <div class="col-span-full">
                <label for="inspection-date" class="block font-semibold text-gray-700 mb-1">Inspection Date:</label>
                <input type="date" id="inspection-date" data-pdf-swap value="" class="w-full px-3 pt-1 pb-1 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500">
            </div>
        </div>


        <!-- LEGEND / INSTRUCTIONS -->
        <div class="bg-blue-50 p-4 rounded-xl border border-blue-200 mb-6 text-sm flex justify-around items-center flex-wrap gap-2">
            <p class="font-bold text-blue-800">Legend:</p>
            <span class="text-green-700 font-semibold">OK (Good Condition)</span>
            <span class="text-gray-700 font-semibold">N/A (Not Applicable)</span>
            <span class="text-red-700 font-semibold">R (Repair Needed/Damage)</span>
            <p class="font-bold text-gray-700">Notes are REQUIRED for R status.</p>
        </div>

        <!-- INSPECTION CHECKLIST -->
        <h2 class="text-2xl font-semibold text-gray-700 mb-4 border-b pb-2">Condition Checklist</h2>
        
        <!-- Inspection Section Template - MOVED OUTSIDE CONTAINER -->
        <template id="section-template">
            <div>
                <!-- Section Header -->
                <div class="section-header rounded-none rounded-t-lg" data-section-title></div>
                
                <!-- COLUMN HEADERS -->
                <div class="check-item font-medium text-gray-600 bg-gray-50 border-b border-gray-200">
                    <span class="text-left font-bold">Item</span>
                    <div class="status-label text-green-700 font-bold">OK</div>
                    <div class="status-label text-gray-700 font-bold">N/A</div>
                    <div class="status-label text-red-700 font-bold">R</div>
                    <span class="text-left font-bold">Notes</span>
                </div>
                <!-- END COLUMN HEADERS -->

                <div class="item-list">
                    <!-- Items go here -->
                </div>
            </div>
        </template>
        
        <!-- Item Row Template - MOVED OUTSIDE CONTAINER -->
        <template id="item-template">
            <div class="check-item bg-white hover:bg-gray-50 transition duration-100 no-page-break">
                <span class="font-medium text-gray-800" data-item-name></span>
                
                <!-- Status Checks -->
                <div class="flex justify-center">
                    <input type="radio" data-status="OK" class="form-radio h-5 w-5 text-green-500 border-green-500 focus:ring-green-500">
                </div>
                <div class="flex justify-center">
                    <input type="radio" data-status="N/A" class="form-radio h-5 w-5 text-gray-500 border-gray-500 focus:ring-gray-500">
                </div>
                <div class="flex justify-center">
                    <input type="radio" data-status="R" class="form-radio h-5 w-5 text-red-500 border-red-500 focus:ring-red-500">
                </div>

                <!-- Notes Input: Added data-pdf-swap marker -->
                <textarea data-notes data-pdf-swap placeholder="Add notes here (required for R)." rows="3" class="input-notes px-3 pt-1 pb-2 text-sm border border-gray-300 rounded-md focus:border-blue-500 focus:ring-blue-500"></textarea>
            </div>
        </template>

        <div id="checklist-container" class="border border-gray-300 rounded-lg">
            <!-- Inspection Sections will be rendered here by JavaScript -->
        </div>
        
        <!-- NEW SECTIONS: KEYS & UTILITIES -->
        <div class="mt-8 pt-4 border-t border-gray-300 keys-section">
            <h2 class="text-2xl font-semibold text-gray-700 mb-3">Key & Utility Documentation</h2>
            <div class="grid grid-cols-1 gap-6 mb-4">
                <div class="md:col-span-2 no-page-break">
                    <label for="keys-provided" class="block font-semibold text-gray-700 mb-1">Keys/Fobs Provided (Move-In) or Returned (Move-Out):</label>
                    <!-- Added data-pdf-swap marker -->
                    <textarea id="keys-provided" data-pdf-swap rows="6" placeholder="E.g., 2 Front Door Keys, 1 Garage Fob, 1 Mailbox Key, and 3 pool access cards were handed over today." class="w-full px-4 pt-1 pb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
                </div>
            </div>
        </div>

        <!-- OVERALL PROPERTY CONDITION -->
        <div class="mt-8 pt-4 border-t border-gray-300 summary-section">
            <h2 class="text-2xl font-semibold text-gray-700 mb-3">Summary and General Comments</h2>
            <div class="mb-4 no-page-break">
                <label for="general-notes" class="block font-semibold text-gray-700 mb-1">General Comments / Required Maintenance Overview:</label>
                <!-- Added data-pdf-swap marker -->
                <textarea id="general-notes" data-pdf-swap rows="8" placeholder="Summarize key findings, urgent repairs, or outstanding issues discussed with the tenant. Ensure all comments are detailed and professional." class="w-full px-4 pt-1 pb-4 border border-gray-300 rounded-lg focus:ring-blue-500 focus:border-blue-500"></textarea>
            </div>
        </div>

        <!-- SIGNATURES SECTION -->
        <div class="mt-8 pt-4 border-t-2 border-blue-600 verification-section no-page-break">
            <h2 class="text-2xl font-semibold text-gray-700 mb-4">Verification & Acknowledgment</h2>
            
            <div class="grid grid-cols-1 md:grid-cols-2 gap-8 text-sm">
                <!-- Tenant Signature Pad -->
                <div class="p-4 border border-gray-200 rounded-lg">
                    <p class="font-bold text-gray-700 mb-2">Tenant Signature:</p>
                    <canvas id="tenant-signature-canvas" class="signature-box w-full"></canvas>
                    <button onclick="clearSignature('tenant-signature-canvas')" class="mt-2 w-full bg-red-100 text-red-600 font-medium py-1 rounded-md hover:bg-red-200 transition duration-150">
                        Clear Signature
                    </button>
                    <!-- UPDATED: tenant-print-name input to pt-1 pb-1 for higher vertical alignment -->
                    <input type="text" id="tenant-print-name" data-pdf-swap placeholder="Print Name" class="w-full mt-2 px-3 pt-1 pb-1 border border-gray-300 rounded-md focus:border-blue-500">
                </div>
                
                <!-- Inspector Signature Pad -->
                <div class="p-4 border border-gray-200 rounded-lg">
                    <p class="font-bold text-gray-700 mb-2">Inspector/Agent Signature:</p>
                    <canvas id="inspector-signature-canvas" class="signature-box w-full"></canvas>
                    <button onclick="clearSignature('inspector-signature-canvas')" class="mt-2 w-full bg-red-100 text-red-600 font-medium py-1 rounded-md hover:bg-red-200 transition duration-150">
                        Clear Signature
                    </button>
                    <!-- UPDATED: inspector-print-name input to pt-1 pb-1 for higher vertical alignment -->
                    <input type="text" id="inspector-print-name" data-pdf-swap placeholder="Print Name" class="w-full mt-2 px-3 pt-1 pb-1 border border-gray-300 rounded-md focus:border-blue-500">
                </div>
            </div>

            <p class="mt-6 text-sm text-gray-500 italic text-center">
                Signatures confirm that the documented conditions accurately reflect the state of the property as observed at the time of inspection.
            </p>
        </div>
    </div>
        <!-- ACTION BUTTONS -->
        <div class="action-buttons mt-10 flex justify-end space-x-4">
            <!-- This will be shown after PDF is generated -->
            <div id="pdf-download-link-container" class="hidden">
                <a id="pdf-download-link" href="#" target="_blank" class="block px-8 py-3 bg-green-600 text-white font-bold rounded-lg shadow-lg hover:bg-green-700 transition duration-150 transform hover:scale-105">
                    Download PDF
                </a>
            </div>
            <button id="save-export-button" onclick="saveInspection()" class="px-8 py-3 bg-blue-600 text-white font-bold rounded-lg shadow-lg hover:bg-blue-700 transition duration-150 transform hover:scale-105">
                Save & Export Report (PDF)
            </button>
            <button onclick="clearForm()" class="px-8 py-3 bg-gray-200 text-gray-800 font-bold rounded-lg shadow-lg hover:bg-gray-300 transition duration-150 transform hover:scale-105">
                Clear Form
            </button>
        </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, signInWithCustomToken, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot, serverTimestamp, collection, getDoc, deleteDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        import { setLogLevel } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // Set Firebase log level to Debug
        setLogLevel('debug');
        
        // --- GLOBAL FIREBASE VARIABLES ---
        const appId = 'default-inspection-app';
        // TODO: PASTE YOUR FIREBASE CONFIGURATION HERE
        const firebaseConfig = {
            apiKey: "YOUR_API_KEY",
            authDomain: "YOUR_PROJECT_ID.firebaseapp.com",
            projectId: "YOUR_PROJECT_ID",
            storageBucket: "YOUR_PROJECT_ID.appspot.com",
            messagingSenderId: "YOUR_SENDER_ID",
            appId: "YOUR_APP_ID"
        };
        const initialAuthToken = null;
        
        let db;
        let auth;
        let userId = null;
        let isAuthReady = false; 
        let tenantSigPad = null;
        let inspectorSigPad = null;
        let unsubscribeReport = null; 
        
        // Inspection Data Structure (Default Checklist)
        let INSPECTION_DATA = [
            {
                title: "Exterior and Grounds",
                items: [
                    "Landscaping/Lawn Condition", "Fences/Gates/Exterior Lights", "Exterior Walls/Siding/Trim", 
                    "Roof Condition (Visual)", "Driveway/Walkways/Patios", "Doors/Locks/Screens"
                ]
            },
            {
                title: "Interior: Living Spaces",
                items: [
                    "Walls/Paint Condition", "Flooring/Carpet Condition", "Windows/Blinds/Curtains", 
                    "Light Fixtures/Outlets/Switches", "Doors/Closets", "AC Vents/Thermostat Function"
                ]
            },
            {
                title: "Kitchen",
                items: [
                    "Cabinets/Drawers/Hardware", "Countertops/Backsplash", "Sink/Faucet/Disposal", 
                    "Refrigerator Condition & Cleanliness", "Oven/Stove/Range Hood", "Dishwasher Condition"
                ]
            }, 
            {
                title: "Bathrooms",
                items: [
                    "Sink/Vanity/Mirror", "Toilet Function & Seal", "Shower/Tub/Grout & Caulk", 
                    "Flooring & Walls", "Ventilation Fan"
                ]
            },
            {
                title: "Safety & Utility",
                items: [
                    "Smoke Detectors/CO Alarms (Tested)", "Water Heater/Utility Area", "Garage Condition (if applicable)", 
                    "Storage/Misc Area"
                ]
            },
            {
                title: "Common Area: Laundry Room",
                items: [
                    "General Cleanliness & Odor", 
                    "Floor/Drain Condition (No standing water)", 
                    "Washer Condition & Operation", 
                    "Dryer Condition & Lint Traps (Empty)", 
                    "Supplies/Folding Area Cleanliness",
                    "Lighting and Security"
                ]
            }
        ];
        
        // --- Signature Pad Logic (Stable) ---

        /** Initializes a canvas element to function as a signature drawing pad. */
        function initializeSignaturePad(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (!canvas) return null;

            const ctx = canvas.getContext('2d');
            let isDrawing = false;
            let lastX = 0;
            let lastY = 0;

            function resizeCanvas() {
                // Capture existing signature data to prevent loss on resize/rotation
                let existingData = null;
                if (canvas.width > 0 && canvas.height > 0) {
                    existingData = canvas.toDataURL();
                }

                const rect = canvas.getBoundingClientRect();
                const scale = window.devicePixelRatio; 
                canvas.width = rect.width * scale;
                canvas.height = rect.height * scale;
                ctx.scale(scale, scale); 
                ctx.lineWidth = 2;
                ctx.lineCap = 'round';
                ctx.strokeStyle = '#000';

                // Restore signature data if it existed
                if (existingData && existingData.length > 5000) {
                    const img = new Image();
                    img.onload = function() {
                        // Draw image to fit new bounds (using CSS dimensions because context is scaled)
                        ctx.drawImage(img, 0, 0, rect.width, rect.height);
                    };
                    img.src = existingData;
                }
            }
            
            resizeCanvas();
            window.addEventListener('resize', resizeCanvas);

            function draw(e) {
                if (!isDrawing) return;
                let clientX, clientY;
                if (e.touches && e.touches.length > 0) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }

                const rect = canvas.getBoundingClientRect();
                const currentX = (clientX - rect.left);
                const currentY = (clientY - rect.top);

                ctx.beginPath();
                ctx.moveTo(lastX, lastY);
                ctx.lineTo(currentX, currentY);
                ctx.stroke();
                [lastX, lastY] = [currentX, currentY];
            }

            function startDraw(e) {
                e.preventDefault(); 
                isDrawing = true;
                let clientX, clientY;
                if (e.touches && e.touches.length > 0) {
                    clientX = e.touches[0].clientX;
                    clientY = e.touches[0].clientY;
                } else {
                    clientX = e.clientX;
                    clientY = e.clientY;
                }
                const rect = canvas.getBoundingClientRect();
                [lastX, lastY] = [(clientX - rect.left), (clientY - rect.top)];
            }

            function stopDraw() {
                isDrawing = false;
            }

            canvas.addEventListener('mousedown', startDraw);
            canvas.addEventListener('mousemove', draw);
            canvas.addEventListener('mouseup', stopDraw);
            canvas.addEventListener('mouseout', stopDraw);
            canvas.addEventListener('touchstart', startDraw);
            canvas.addEventListener('touchmove', draw);
            canvas.addEventListener('touchend', stopDraw);
            canvas.addEventListener('touchcancel', stopDraw);
            
            canvas.clearSignature = () => {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                resizeCanvas(); 
            };
            
            canvas.getSignatureData = () => {
                const dataUrl = canvas.toDataURL('image/png');
                // Return null if the signature data is too small (i.e., canvas is empty or just a small dot)
                return dataUrl.length < 5000 ? null : dataUrl; 
            }
            
            canvas.setSignatureData = (dataUrl) => {
                canvas.clearSignature(); 
                if (!dataUrl) return;
                
                const img = new Image();
                img.onload = function() {
                    const scale = window.devicePixelRatio;
                    // Draw the image onto the canvas, compensating for device pixel ratio
                    ctx.drawImage(img, 0, 0, canvas.width / scale, canvas.height / scale);
                };
                img.src = dataUrl;
            };
            
            return canvas;
        }
        
        window.clearSignature = function(canvasId) {
            const canvas = document.getElementById(canvasId);
            if (canvas && typeof canvas.clearSignature === 'function') {
                canvas.clearSignature();
            }
        }

        // --- UI Rendering (Stable) ---

        /** Renders the inspection checklist based on the global INSPECTION_DATA. */
        function renderChecklist() {
            const container = document.getElementById('checklist-container');
            const sectionTemplate = document.getElementById('section-template');
            const itemTemplate = document.getElementById('item-template');

            if (!container || !sectionTemplate || !itemTemplate) {
                console.error("ERROR: Failed to find critical elements. Checklist cannot be rendered.");
                return; 
            }
            
            container.innerHTML = ''; // Clear existing checklist

            INSPECTION_DATA.forEach(section => {
                const sectionClone = sectionTemplate.content.cloneNode(true);
                const sectionDiv = sectionClone.querySelector('div');
                const sectionHeader = sectionDiv.querySelector('[data-section-title]');
                sectionHeader.textContent = section.title;
                const itemsContainer = sectionDiv.querySelector('.item-list');

                section.items.forEach(itemName => {
                    const itemClone = itemTemplate.content.cloneNode(true);
                    const itemNameSpan = itemClone.querySelector('[data-item-name]');
                    itemNameSpan.textContent = itemName;
                    
                    itemClone.querySelectorAll('input[type="radio"]').forEach(radio => {
                        // Unique name based on section title and item name
                        radio.name = `status-${section.title.replace(/\s/g, '-')}-${itemName.replace(/\s/g, '-')}`;
                        radio.addEventListener('change', handleStatusChange);
                    });

                    itemsContainer.appendChild(itemClone);
                });
                container.appendChild(sectionDiv);
            });
        }
        
        function handleStatusChange(event) {
            const radio = event.target;
            const status = radio.dataset.status;
            const itemRow = radio.closest('.check-item');
            
            if (!itemRow) return;

            const notesInput = itemRow.querySelector('[data-notes]');

            // Mandatory notes for "R" status
            if (status === 'R') {
                notesInput.setAttribute('required', 'true');
                notesInput.classList.add('border-red-500', 'ring-2', 'ring-red-200');
            } else {
                notesInput.removeAttribute('required');
                notesInput.classList.remove('border-red-500', 'ring-2', 'ring-red-200');
            }
            
            // Re-check validation on change (visually remove red if note is now present)
            if (status === 'R' && notesInput.value.trim()) {
                notesInput.classList.remove('border-red-500', 'ring-2', 'ring-red-200');
            }
        }

        /**
         * Gathers all data from the form.
         * @returns {object} - The inspection data.
         */
        function getFormData() {
            const safeGetValue = (id) => {
                const element = document.getElementById(id);
                return element?.value?.trim() || ''; 
            };
            
            const safeGetPlainValue = (id, defaultValue = '') => {
                const element = document.getElementById(id);
                return element?.value || defaultValue;
            };

            const data = {
                inspectionType: safeGetPlainValue('inspection-type', 'MidTerm'),
                address: safeGetValue('property-address'),
                tenantName: safeGetValue('tenant-name'),
                inspectionDate: safeGetPlainValue('inspection-date'),
                inspectorName: safeGetValue('inspector-name'),
                generalComments: safeGetValue('general-notes'),
                keysProvided: safeGetValue('keys-provided'),

                tenantPrintName: safeGetValue('tenant-print-name'),
                inspectorPrintName: safeGetValue('inspector-print-name'),
                
                tenantSignature: tenantSigPad ? tenantSigPad.getSignatureData() : null,
                inspectorSignature: inspectorSigPad ? inspectorSigPad.getSignatureData() : null,
                
                checklistStructure: INSPECTION_DATA, 
                items: []
            };

            document.querySelectorAll('#checklist-container .check-item').forEach(itemRow => {
                const itemNameSpan = itemRow.querySelector('[data-item-name]');
                if (!itemNameSpan) return;
                
                const itemName = itemNameSpan.textContent;
                const statusRadio = itemRow.querySelector('input[type="radio"]:checked');
                const notes = itemRow.querySelector('[data-notes]')?.value || '';

                data.items.push({
                    name: itemName,
                    status: statusRadio ? statusRadio.dataset.status : 'N/A', 
                    notes: notes.trim()
                });
            });

            return data;
        }

        /* ========================================================================= */
        /* --- CRITICAL PDF FIX: TEXTAREA SWAP LOGIC --- */
        
        const originalTextareas = [];

        /** Replaces all marked inputs/textareas with non-scrollable divs for PDF capture. */
        function prepareElementsForPdf() {
            const elements = document.querySelectorAll('[data-pdf-swap]');
            originalTextareas.length = 0; // Clear array

            elements.forEach(el => {
                const tempDiv = document.createElement('div');
                tempDiv.className = el.className;
                
                if (el.tagName === 'TEXTAREA') {
                    tempDiv.classList.add('pdf-temp-text');
                } else {
                    tempDiv.classList.add('pdf-temp-input');
                }
                
                let content = '';
                if (el.tagName === 'SELECT') {
                    content = el.options[el.selectedIndex]?.text || '';
                } else if (el.type === 'date' && el.value) {
                    // Simple date formatting YYYY-MM-DD -> MM/DD/YYYY
                    const parts = el.value.split('-');
                    content = parts.length === 3 ? `${parts[1]}/${parts[2]}/${parts[0]}` : el.value;
                } else {
                    content = el.value || '';
                }

                if (!content || content.trim() === '') {
                    content = '\u00A0'; // Non-breaking space to maintain height
                }

                tempDiv.textContent = content;

                // Store original textarea and replace it in the DOM
                originalTextareas.push({ original: el, replacement: tempDiv });
                el.replaceWith(tempDiv);
            });
        }

        /** Restores the original elements after PDF capture. */
        function restoreElements() {
            originalTextareas.forEach(pair => {
                pair.replacement.replaceWith(pair.original);
            });
            originalTextareas.length = 0; // Clear array
        }
        
        /** Utility to create a delay using a Promise - gives the DOM time to repaint */
        function delay(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }

        /* ========================================================================= */

        // --- Data Persistence (Firestore) ---

        /** Constructs the unique document ID for saving reports. */
        function getReportDocId() {
            const address = document.getElementById('property-address')?.value.trim(); 
            const type = document.getElementById('inspection-type')?.value; 

            if (!address) return null;
            const addressKey = address.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
            return `${addressKey}_${type}`;
        }
        
        /** Constructs the unique document ID for saving templates. */
        function getTemplateDocId() {
            const templateName = document.getElementById('template-name')?.value.trim(); 
            if (!templateName) return null;
            return templateName.replace(/[^a-zA-Z0-9]/g, '_').toLowerCase();
        }

        /**
         * Creates a temporary paginated DOM structure for PDF generation.
         * This ensures elements are physically separated into pages before screenshotting,
         * preventing cuts through text boxes or checklist items.
         */
        function createPaginatedLayout(sourceElem) {
            const pageWidth = 1100; // Matches .container max-width
            // A4 Ratio is ~1.414. 1100 * 1.414 = 1555. 
            // We use a slightly smaller height to ensure safe margins.
            const pageHeight = 1500; 
            
            const container = document.createElement('div');
            container.id = 'pdf-pagination-container';
            container.style.position = 'absolute';
            container.style.left = '-9999px'; // Hide off-screen
            container.style.top = '0';
            container.style.width = pageWidth + 'px';
            
            document.body.appendChild(container);

            let currentPage = document.createElement('div');
            // Add padding to simulate page margins directly on the HTML page
            currentPage.className = 'pdf-page bg-white p-12 mb-8'; 
            currentPage.style.width = pageWidth + 'px';
            currentPage.style.minHeight = pageHeight + 'px';
            currentPage.style.position = 'relative';
            currentPage.style.overflow = 'hidden'; // Ensure no spillover
            
            container.appendChild(currentPage);
            
            const pages = [currentPage];

            // Helper to check if element fits, else create new page
            function checkAndBreak(element) {
                currentPage.appendChild(element);
                
                if (currentPage.scrollHeight > pageHeight) {
                    currentPage.removeChild(element);
                    
                    // Create new page
                    currentPage = document.createElement('div');
                    currentPage.className = 'pdf-page bg-white p-12 mb-8';
                    currentPage.style.width = pageWidth + 'px';
                    currentPage.style.minHeight = pageHeight + 'px';
                    currentPage.style.position = 'relative';
                    currentPage.style.overflow = 'hidden';
                    
                    container.appendChild(currentPage);
                    pages.push(currentPage);
                    
                    currentPage.appendChild(element);
                    return true; // Page break occurred
                }
                return false;
            }

            const children = Array.from(sourceElem.children);
            
            for (const child of children) {
                // Special handling for Checklist to break inside sections/items
                if (child.id === 'checklist-container') {
                    let checklistWrapper = child.cloneNode(false);
                    checkAndBreak(checklistWrapper);
                    
                    const sections = Array.from(child.children);
                    for (const section of sections) {
                        let sectionWrapper = section.cloneNode(false);
                        checklistWrapper.appendChild(sectionWrapper);
                        
                        // If wrapper itself pushed over (unlikely), handle it? 
                        // For simplicity, we rely on the items loop to catch overflows.

                        const sectionChildren = Array.from(section.children);
                        for (const secChild of sectionChildren) {
                            if (secChild.classList.contains('item-list')) {
                                let itemListWrapper = secChild.cloneNode(false);
                                sectionWrapper.appendChild(itemListWrapper);
                                
                                const items = Array.from(secChild.children);
                                for (const item of items) {
                                    const itemClone = item.cloneNode(true);
                                    itemListWrapper.appendChild(itemClone);
                                    
                                    if (currentPage.scrollHeight > pageHeight) {
                                        itemListWrapper.removeChild(itemClone);
                                        
                                        // Start New Page & Recreate Context
                                        currentPage = document.createElement('div');
                                        currentPage.className = 'pdf-page bg-white p-12 mb-8';
                                        currentPage.style.width = pageWidth + 'px';
                                        currentPage.style.minHeight = pageHeight + 'px';
                                        container.appendChild(currentPage);
                                        pages.push(currentPage);
                                        
                                        checklistWrapper = child.cloneNode(false);
                                        currentPage.appendChild(checklistWrapper);
                                        sectionWrapper = section.cloneNode(false);
                                        checklistWrapper.appendChild(sectionWrapper);
                                        itemListWrapper = secChild.cloneNode(false);
                                        sectionWrapper.appendChild(itemListWrapper);
                                        
                                        itemListWrapper.appendChild(itemClone);
                                    }
                                }
                            } else {
                                // Headers
                                const clone = secChild.cloneNode(true);
                                sectionWrapper.appendChild(clone);
                                
                                if (currentPage.scrollHeight > pageHeight) {
                                    sectionWrapper.removeChild(clone);
                                    
                                    currentPage = document.createElement('div');
                                    currentPage.className = 'pdf-page bg-white p-12 mb-8';
                                    currentPage.style.width = pageWidth + 'px';
                                    currentPage.style.minHeight = pageHeight + 'px';
                                    container.appendChild(currentPage);
                                    pages.push(currentPage);
                                    
                                    checklistWrapper = child.cloneNode(false);
                                    currentPage.appendChild(checklistWrapper);
                                    sectionWrapper = section.cloneNode(false);
                                    checklistWrapper.appendChild(sectionWrapper);
                                    
                                    sectionWrapper.appendChild(clone);
                                }
                            }
                        }
                    }
                } else {
                    // Normal top-level element
                    const clone = child.cloneNode(true);

                    // --- FIX FOR SIGNATURES ---
                    // If this is the signature section, replace canvases with static images
                    // because cloneNode() does not copy canvas drawings.
                    if (clone.classList.contains('verification-section')) {
                        // Remove the "Clear Signature" buttons from the PDF version
                        clone.querySelectorAll('button').forEach(btn => btn.remove());

                        const originalPads = {
                            'tenant-signature-canvas': tenantSigPad,
                            'inspector-signature-canvas': inspectorSigPad
                        };

                        clone.querySelectorAll('canvas').forEach(clonedCanvas => {
                            const originalPad = originalPads[clonedCanvas.id];
                            const signatureData = originalPad ? originalPad.getSignatureData() : null;
                            
                            // Create an <img> if there's a signature, otherwise an empty <div>
                            const replacement = document.createElement(signatureData ? 'img' : 'div');
                            replacement.className = 'signature-box w-full'; // Keep the styling
                            
                            if (signatureData) {
                                replacement.src = signatureData;
                            }
                            
                            clonedCanvas.replaceWith(replacement);
                        });
                    }
                    // --- END FIX ---
                    
                    checkAndBreak(clone);
                }
            }
            
            return { container, pages };
        }

        /**
         * Converts the visible report content to a multi-page PDF using html2canvas and jsPDF.
         * Includes the critical DOM swap to fix text clipping.

         */
        async function generatePdfBlobUrl() {
            alertMessage("Generating PDF, please wait...", "bg-indigo-100 border-indigo-400 text-indigo-700");
            
            const input = document.getElementById('report-content');
            
            // Temporarily hide action buttons and template section for a clean capture
            const actionButtons = document.querySelector('.action-buttons');
            const templateSection = document.querySelector('.template-section');
            if (actionButtons) actionButtons.style.display = 'none';
            if (templateSection) templateSection.style.display = 'none';
            
            // CRITICAL FIX 1: Save current scroll position and scroll to top/left 
            const scrollTop = window.scrollY || document.documentElement.scrollTop;
            const scrollLeft = window.scrollX || document.documentElement.scrollLeft;
            window.scrollTo(0, 0); 
            
            // --- CRITICAL FIX 2: HARD FIX - REPLACE TEXTAREAS WITH DIVS ---
            prepareElementsForPdf();
            await delay(100); // Wait for the DOM replacement to fully render
            
            // --- NEW PAGINATION LOGIC ---
            // Instead of one big screenshot, we split DOM into pages
            const { container: paginatedContainer, pages } = createPaginatedLayout(input);

            const { jsPDF } = window.jspdf;

            try {
                const pdf = new jsPDF('p', 'mm', 'a4');
                const pdfWidth = pdf.internal.pageSize.getWidth();
                const pdfHeight = pdf.internal.pageSize.getHeight();
                
                for (let i = 0; i < pages.length; i++) {
                    if (i > 0) pdf.addPage();

                    const page = pages[i];
                    
                    // Capture the specific page div
                    const canvas = await html2canvas(page, {
                        scale: 2, // Good balance of quality and speed
                        useCORS: true,
                        allowTaint: true,
                        windowWidth: 1100 // Match the fixed width we set
                    });

                    const imgData = canvas.toDataURL('image/jpeg', 0.9);
                    
                    // Calculate height to fit width
                    const imgHeight = canvas.height * pdfWidth / canvas.width;
                    
                    // Add image to PDF (0,0 because the DOM page already has padding)
                    pdf.addImage(imgData, 'JPEG', 0, 0, pdfWidth, imgHeight);
                }
                
                const blob = pdf.output('blob');
                const blobUrl = URL.createObjectURL(blob);
                return blobUrl;

            } catch (error) {
                console.error("PDF Export Error: ", error);
                alertMessage("Failed to generate PDF. See console for details.", "bg-red-100 border-red-400 text-red-700");
                throw error; // Re-throw the error so the calling function knows it failed
            } finally {
                // --- CRITICAL FIX 3: RESTORE TEXTAREAS ---
                if (paginatedContainer) paginatedContainer.remove();
                restoreElements();
                // ------------------------------------------

                // CRITICAL FIX 4: Restore original scroll position
                window.scrollTo(scrollLeft, scrollTop);
                
                // Restore action buttons and template section
                if (actionButtons) actionButtons.style.display = 'flex';
                if (templateSection) templateSection.style.display = 'flex';
            }
        }


        window.saveInspection = async function() {
            const inspectionData = getFormData();
            const docId = getReportDocId();

            if (!docId) {
                alertMessage("Please enter a Property Address and select an Inspection Type.", "bg-yellow-100 border-yellow-400 text-yellow-700");
                document.getElementById('property-address').focus();
                return;
            }

            // Validation Check: Ensure notes are present for "R" status
            let validationError = false;
            document.querySelectorAll('#checklist-container .check-item').forEach(itemRow => {
                const statusRadio = itemRow.querySelector('input[type="radio"]:checked');
                const notesInput = itemRow.querySelector('[data-notes]');
                const status = statusRadio ? statusRadio.dataset.status : null;

                if (status === 'R' && !notesInput?.value.trim()) { 
                    notesInput.classList.add('border-red-500', 'ring-2', 'ring-red-200');
                    validationError = true;
                } else {
                    notesInput?.classList.remove('border-red-500', 'ring-2', 'ring-red-200'); 
                }
            });

            if (validationError) {
                alertMessage("Notes are required for all items marked 'R' (Repair Needed).", "bg-yellow-100 border-yellow-400 text-yellow-700");
                return;
            }

            const saveButton = document.getElementById('save-export-button');
            const downloadContainer = document.getElementById('pdf-download-link-container');

            saveButton.disabled = true;
            downloadContainer.classList.add('hidden');

            try {
                if (userId) {
                    saveButton.textContent = 'Saving to Cloud...';
                    const docRef = doc(db, `artifacts/${appId}/public/data/inspections`, docId);
                    await setDoc(docRef, {
                        ...inspectionData,
                        updatedAt: serverTimestamp(),
                        userId: userId,
                    });
                    alertMessage(`Saved successfully! Now generating PDF...`, "bg-blue-100 border-blue-400 text-blue-700");
                } else {
                    alertMessage("Offline Mode: Generating PDF...", "bg-yellow-100 border-yellow-400 text-yellow-700");
                }

                saveButton.textContent = 'Generating PDF...';
                const blobUrl = await generatePdfBlobUrl();

                const downloadLink = document.getElementById('pdf-download-link');
                downloadLink.href = blobUrl;
                downloadContainer.classList.remove('hidden');
                alertMessage('PDF Ready! Click "Download PDF" to view.', "bg-green-100 border-green-400 text-green-700");

            } catch (e) {
                console.error("Error during save/export process: ", e);
                // The PDF generation function already shows an alert on failure.
            } finally {
                saveButton.disabled = false;
                saveButton.textContent = 'Save & Export Report (PDF)';
            }
        }

        /**
         * Loads inspection data based on address and type.
         */
        function loadInspection(docId, currentAddress, currentType) {
            if (!docId || !userId) return; 

            if (unsubscribeReport) {
                unsubscribeReport(); // Clear previous listener
            }

            const docRef = doc(db, `artifacts/${appId}/public/data/inspections`, docId);

            unsubscribeReport = onSnapshot(docRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    applyDataToForm(data);
                    alertMessage("Inspection loaded successfully (real-time updates active).", "bg-blue-100 border-blue-400 text-blue-700");
                } else {
                    // Report not found. Apply default/empty data but PRESERVE user input.
                    applyDataToForm({ 
                        address: currentAddress, 
                        inspectionType: currentType 
                    });
                    alertMessage("No existing report found for this address/type. Starting new.", "bg-gray-100 border-gray-400 text-gray-700");
                }
            }, (error) => {
                console.error("Error fetching inspection: ", error);
                alertMessage("Error loading inspection data. Check permissions/console.", "bg-red-100 border-red-400 text-red-700");
            });
        }
        
        window.saveAsTemplate = async function() {
            if (!userId) {
                alertMessage("Authentication is required to save templates. Please wait for Auth Ready.", "bg-red-100 border-red-400 text-red-700");
                return;
            }
            
            const templateId = getTemplateDocId();
            if (!templateId) {
                alertMessage("Please enter a Template Name.", "bg-yellow-100 border-yellow-400 text-yellow-700");
                document.getElementById('template-name')?.focus(); 
                return;
            }

            const docRef = doc(db, `artifacts/${appId}/users/${userId}/templates`, templateId);
            
            try {
                await setDoc(docRef, {
                    templateName: document.getElementById('template-name')?.value.trim(), 
                    checklistStructure: INSPECTION_DATA,
                    updatedAt: serverTimestamp(),
                    userId: userId
                });
                alertMessage(`Template '${templateId}' saved!`, "bg-green-100 border-green-400 text-green-700");
            } catch (e) {
                console.error("Error saving template: ", e);
                alertMessage("Failed to save template.", "bg-red-100 border-red-400 text-red-700");
            }
        }

        window.loadTemplate = async function() {
            if (!userId) {
                alertMessage("Authentication is required to load templates. Please wait for Auth Ready.", "bg-red-100 border-red-400 text-red-700");
                return;
            }

            const templateId = getTemplateDocId();
            if (!templateId) {
                alertMessage("Please enter the Template Name you wish to load.", "bg-yellow-100 border-yellow-400 text-yellow-700");
                document.getElementById('template-name')?.focus(); 
                return;
            }

            const docRef = doc(db, `artifacts/${appId}/users/${userId}/templates`, templateId);
            
            try {
                const snap = await getDoc(docRef);
                
                if (snap.exists() && snap.data().checklistStructure) {
                    INSPECTION_DATA = snap.data().checklistStructure;
                    renderChecklist();
                    // Clear the rest of the form to start a new report
                    clearReportDetails();
                    alertMessage(`Template '${templateId}' loaded successfully!`, "bg-blue-100 border-blue-400 text-blue-700");
                } else {
                    alertMessage(`Template '${templateId}' not found.`, "bg-yellow-100 border-yellow-400 text-yellow-700");
                }
            } catch (e) {
                console.error("Error loading template: ", e);
                alertMessage("Failed to load template.", "bg-red-100 border-red-400 text-red-700");
            }
        }

        /**
         * Applies loaded data to the form fields, including loading signatures.
         * @param {object} data - The inspection data from Firestore.
         */
        function applyDataToForm(data) {
            const addressInput = document.getElementById('property-address');
            const typeSelect = document.getElementById('inspection-type');
            
            typeSelect.value = data.inspectionType || typeSelect?.value || 'MidTerm';
            addressInput.value = data.address || addressInput?.value || '';


            document.getElementById('tenant-name').value = data.tenantName || '';
            document.getElementById('inspection-date').value = data.inspectionDate || new Date().toISOString().substring(0, 10);
            document.getElementById('inspector-name').value = data.inspectorName || '';
            document.getElementById('general-notes').value = data.generalComments || '';
            document.getElementById('keys-provided').value = data.keysProvided || '';

            document.getElementById('tenant-print-name').value = data.tenantPrintName || '';
            document.getElementById('inspector-print-name').value = data.inspectorPrintName || '';

            if (data.checklistStructure) {
                INSPECTION_DATA = data.checklistStructure;
                renderChecklist();
            }

            if (tenantSigPad) tenantSigPad.setSignatureData(data.tenantSignature);
            if (inspectorSigPad) inspectorSigPad.setSignatureData(data.inspectorSignature);

            const itemsToLoad = data.items || []; 
            itemsToLoad.forEach(itemData => {
                const itemRows = document.querySelectorAll('.check-item');
                let foundItem = null;

                for (const itemRow of itemRows) {
                    const itemNameSpan = itemRow.querySelector('[data-item-name]');
                    if (itemNameSpan && itemNameSpan.textContent === itemData.name) {
                        foundItem = itemRow;
                        break;
                    }
                }

                if (foundItem) {
                    const radio = foundItem.querySelector(`input[data-status="${itemData.status}"]`);
                    if (radio) {
                        radio.checked = true;
                        radio.dispatchEvent(new Event('change')); 
                    }
                    const notesInput = foundItem.querySelector('[data-notes]');
                    if (notesInput) {
                        notesInput.value = itemData.notes || '';
                    }
                }
            });
        }
        
        /** Clears only the report-specific fields, preserving checklist structure and Address/Type. */
        function clearReportDetails() {
            
            document.getElementById('tenant-name').value = '';
            document.getElementById('inspection-date').value = new Date().toISOString().substring(0, 10);
            document.getElementById('inspector-name').value = '';
            document.getElementById('general-notes').value = '';
            document.getElementById('keys-provided').value = '';
            document.getElementById('tenant-print-name').value = '';
            document.getElementById('inspector-print-name').value = '';
            
            if (tenantSigPad) tenantSigPad.clearSignature();
            if (inspectorSigPad) inspectorSigPad.clearSignature();
            
            // Uncheck all items and clear notes
            document.querySelectorAll('input[type="radio"]').forEach(radio => radio.checked = false);
            document.querySelectorAll('[data-notes]').forEach(notesInput => {
                notesInput.value = '';
                notesInput.removeAttribute('required');
                notesInput.classList.remove('border-red-500', 'ring-2', 'ring-red-200');
            });
        }

        window.clearForm = function() {
             // Reset to default checklist structure
            INSPECTION_DATA = [
                {
                    title: "Exterior and Grounds",
                    items: [
                        "Landscaping/Lawn Condition", "Fences/Gates/Exterior Lights", "Exterior Walls/Siding/Trim", 
                        "Roof Condition (Visual)", "Driveway/Walkways/Patios", "Doors/Locks/Screens"
                    ]
                },
                {
                    title: "Interior: Living Spaces",
                    items: [
                        "Walls/Paint Condition", "Flooring/Carpet Condition", "Windows/Blinds/Curtains", 
                        "Light Fixtures/Outlets/Switches", "Doors/Closets", "AC Vents/Thermostat Function"
                    ]
                },
                {
                    title: "Kitchen",
                    items: [
                        "Cabinets/Drawers/Hardware", "Countertops/Backsplash", "Sink/Faucet/Disposal", 
                        "Refrigerator Condition & Cleanliness", "Oven/Stove/Range Hood", "Dishwasher Condition"
                    ]
                }, 
                {
                    title: "Bathrooms",
                    items: [
                        "Sink/Vanity/Mirror", "Toilet Function & Seal", "Shower/Tub/Grout & Caulk", 
                        "Flooring & Walls", "Ventilation Fan"
                    ]
                },
                {
                    title: "Safety & Utility",
                    items: [
                        "Smoke Detectors/CO Alarms (Tested)", "Water Heater/Utility Area", "Garage Condition (if applicable)", 
                        "Storage/Misc Area"
                    ]
                }
            ];
            
            renderChecklist();
            clearReportDetails();

            document.getElementById('property-address').value = ''; 
            document.getElementById('inspection-type').value = 'MidTerm';
            document.getElementById('template-name').value = '';

            if (unsubscribeReport) {
                unsubscribeReport(); 
                unsubscribeReport = null;
            }
            sessionStorage.removeItem('inspection_autosave'); // Clear local backup
            alertMessage("Form completely cleared. Default checklist restored.", "bg-gray-100 border-gray-400 text-gray-700");
        }


        // --- Authentication and Initialization ---

        async function initAuthAndFirestore() {
            // If the config is still the default placeholder, skip Firebase initialization entirely.
            if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                console.log("Offline Mode: No Firebase configuration detected. Cloud features disabled.");
                return;
            }
            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                
                if (initialAuthToken) {
                    await signInWithCustomToken(auth, initialAuthToken);
                } else {
                    await signInAnonymously(auth);
                }

                onAuthStateChanged(auth, (user) => {
                    if (user) {
                        userId = user.uid;
                        isAuthReady = true;
                        console.log("Authentication successful. User ID:", userId);
                        
                        setupInspectionListener(); 
                    } else {
                        userId = null;
                        isAuthReady = true;
                        console.log("Signed out or anonymous sign-in failed.");
                    }
                });
            } catch (error) {
                console.error("Firebase Initialization Error:", error);
            }
        }

        function setupInspectionListener() {
            const addressInput = document.getElementById('property-address');
            const typeSelect = document.getElementById('inspection-type');
            
            const triggerLoad = () => {
                const currentAddress = addressInput?.value.trim() || '';
                const currentType = typeSelect?.value || 'MidTerm';
                const docId = getReportDocId();

                if (currentAddress) {
                    loadInspection(docId, currentAddress, currentType); 
                } else if (unsubscribeReport) {
                    unsubscribeReport();
                    unsubscribeReport = null;
                    clearReportDetails(); 
                }
            };

            addressInput?.addEventListener('change', triggerLoad); 
            typeSelect?.addEventListener('change', triggerLoad); 
            
            triggerLoad(); 
        }

        // --- Auto-Save / Restore Logic for Rotation Stability ---
        
        function saveLocalState() {
            // Don't save if we are just loading
            const data = getFormData();
            sessionStorage.setItem('inspection_autosave', JSON.stringify(data));
        }

        function restoreLocalState() {
            const saved = sessionStorage.getItem('inspection_autosave');
            if (saved) {
                try {
                    const data = JSON.parse(saved);
                    // Only restore if the address matches or if address was empty (new report)
                    const currentAddr = document.getElementById('property-address').value;
                    if (!currentAddr || currentAddr === data.address) {
                        applyDataToForm(data);
                        console.log("Restored state from local storage (rotation fix).");
                    }
                } catch (e) {
                    console.error("Failed to restore local state", e);
                }
            }
        }

        let saveTimeout;
        function triggerAutoSave() {
            clearTimeout(saveTimeout);
            saveTimeout = setTimeout(saveLocalState, 500);
        }

        function initApp() {
            document.getElementById('inspection-date').value = new Date().toISOString().substring(0, 10);
            
            // 1. Render the initial checklist structure
            renderChecklist();
            
            // 2. Initialize signature pads
            tenantSigPad = initializeSignaturePad('tenant-signature-canvas');
            inspectorSigPad = initializeSignaturePad('inspector-signature-canvas');
            
            // 3. Attempt to restore local state (fixes reload-on-rotation issues)
            restoreLocalState();

            // 4. Attach Auto-Save Listeners
            document.getElementById('report-content').addEventListener('change', triggerAutoSave);
            document.getElementById('report-content').addEventListener('input', triggerAutoSave);

            // 3. Initialize Firebase and authentication listener
            initAuthAndFirestore();
        }

        window.addEventListener('load', initApp);


        // --- Custom Alert/Message Box ---
        function alertMessage(message, classes = "bg-blue-100 border-blue-400 text-blue-700") {
            const existingNotification = document.getElementById('app-notification');
            if (existingNotification) existingNotification.remove();

            const notification = document.createElement('div');
            notification.id = 'app-notification';
            notification.textContent = message;
            notification.className = `fixed top-4 right-4 z-50 p-4 rounded-lg border shadow-xl transition-opacity duration-300 ${classes}`;
            
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.style.opacity = '0';
                setTimeout(() => notification.remove(), 300);
            }, 4000);
        }
        
    </script>
</body>
</html>
